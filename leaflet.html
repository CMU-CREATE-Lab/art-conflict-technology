<!doctype html>
<html>
  <head>
    <title>ACT 2016 -- PIT Map</title>
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        padding: 0;
        margin: 0;
        background: rgb(14, 21, 30);
        height: 100%;
        font-family: Tahoma, Geneva, Verdana, sans-serif;
        font-size:12px;
        color:#808080;
      }

      #map {
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: #333;
      }
    </style>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="geojson-vt-dev.js"></script>
    <script src="L.CanvasTiles.js"></script>
    <script type="text/javascript" src="dat.gui.min.js"></script>

    <script>

      var leafletMap;
      var tileLayer;
      var censusdata;
      var citydata;


      var gui;
      var mapOptions;

      var currentCensusColor = false;
      var MapOptions = function() {
        this.currentCensusSelection = '';
      };

      function initGui() {
        propelOptions = new MapOptions();
        gui = new dat.GUI();
        var f1 = gui.addFolder('Housing Units');
        var opts = {'': false, 'Total' : 'housing_units_color', 'Occupied': 'housing_units_occupied_color', 'Vacant': 'housing_units_vacant_color'}
        var con = f1.add(propelOptions, 'currentCensusSelection', opts).name('Selection');
        con.onChange(function(newValue) {
          if (newValue != '') {
            currentCensusColor = newValue;
            tileLayer.redraw();
          } else {
            currentCensusColor = false;
            tileLayer.redraw();            
          }});

        f1.open();

      }

      function initMap() {
        var leafletMap  = L.map('map').setView([40.4397, -79.9674], 12);
        L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-background,$fff[difference],$fff[@23],$fff[hsl-saturation@20],toner-lines[destination-in])/{z}/{x}/{y}.png").addTo(leafletMap);
        
        /*
        L.tileLayer("http://{s}.sm.mapstack.stamen.com/(watercolor,$fff[hsl-saturation@50],$ff5500[hsl-color@30]),(naip,$fff[hsl-saturation@20],mapbox-water[destination-out])[overlay]/{z}/{x}/{y}.png").addTo(leafletMap);
        */
        return leafletMap;
      }

      function get(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.onload = function() {
          if (callback) {
            var data = JSON.parse(xhr.responseText);
            callback(data);
          }
        }
        xhr.send();
      }

      function initTiles(data) {
        censusdata = data;
        var tileOptions = {
          maxZoom: 20,  // max zoom to preserve detail on
          tolerance: 5, // simplification tolerance (higher means simpler)
          extent: 4096, // tile extent (both width and height)
          buffer: 64,   // tile buffer on each side
          debug: 0,      // logging level (0 to disable, 1 or 2)

          indexMaxZoom: 0,        // max zoom in the initial tile index
          indexMaxPoints: 100000, // max number of points per tile in the index
        };
        //-------------------------------------------------
        function colorizeFeatures(data) {
          var counter = 0;
          for (var i = 0; i < data.features.length; i++) {
            data.features[i].properties.color = 'hsl(' + 360 * Math.random() + ', 50%, 50%)';
            counter += data.features[i].geometry.coordinates[0].length;
          }
          return counter;
        }

        var tileIndex = geojsonvt(data, tileOptions);

        //colorizeFeatures(data);

        tileLayer = L.canvasTiles().params({ debug: false, padding: 5 }).drawing(drawingOnCanvas);

        var pad = 0;

        tileLayer.addTo(leafletMap);


        function drawingOnCanvas(canvasOverlay, params) {
          var bounds = params.bounds;
          params.tilePoint.z = params.zoom;

          var ctx = params.canvas.getContext('2d');
          ctx.globalCompositeOperation = 'source-over';


          console.log('getting tile z' + params.tilePoint.z + '-' + params.tilePoint.x + '-' + params.tilePoint.y);

          var tile = tileIndex.getTile(params.tilePoint.z, params.tilePoint.x, params.tilePoint.y);
          if (!tile) {
            console.log('tile empty');
            return;
          }

          ctx.clearRect(0, 0, params.canvas.width, params.canvas.height);

          var features = tile.features;

          ctx.strokeStyle = 'grey';


          for (var i = 0; i < features.length; i++) {
            var feature = features[i],
            type = feature.type;

            ctx.fillStyle = feature.tags.color ? feature.tags.color : 'rgba(255,0,0,0.05)';
            ctx.fillStyle = currentCensusColor ? feature.tags[currentCensusColor] : 'rgba(0,0,255,0.05)';
            ctx.fillStyle = currentCensusColor ? feature.tags[currentCensusColor] : feature.tags.per_block_vacancy_color //feature.tags.pop_density_color;
            if (feature.tags['GEOID10'] == '420039822001015') {
              console.log(feature)
              //ctx.fillStyle = 'rgba(0,255,0,1.0)';
            }

            ctx.beginPath();


            for (var j = 0; j < feature.geometry.length; j++) {
              var geom = feature.geometry[j];

              if (type === 1) {
                ctx.arc(geom[0] * ratio + pad, geom[1] * ratio + pad, 2, 0, 2 * Math.PI, false);
                continue;
              }

              for (var k = 0; k < geom.length; k++) {
                var p = geom[k];
                var extent = 4096;
 
                var x = p[0] / extent * 256;
                var y = p[1] / extent * 256;
                if (k) ctx.lineTo(x  + pad, y   + pad);
                else ctx.moveTo(x  + pad, y  + pad);
              }
            }
            if (type === 3 || type === 1) ctx.fill('evenodd');
              ctx.stroke();
            }

          };
        }

        function loadGeoJSON(data) {
          citydata = data;
          var featureLayer = new L.GeoJSON();
            // Set a default style for out the polygons will appear
            var defaultStyle = {
                color: "#333333",
                weight: 2,
                opacity: 0.2,
                fillOpacity: 0.0,
                fillColor: "#999999"
            };
            var highlightStyle = {
                color: '#333333', 
                weight: 6,
                opacity: 0.8,
                fillOpacity: 0.15,
                fillColor: '#999999'
            };       
            var onEachFeature = function (feature, layer) {
              layer.setStyle(defaultStyle);
              layer.on("mouseover", function (e) {
                // Change the style to the highlighted version
                layer.setStyle(highlightStyle);
              });
             layer.on("mouseout", function (e) {
                // Start by reverting the style back
                layer.setStyle(defaultStyle); 
              });              
            }
            var featureLayer = L.geoJson(data, {
              // And link up the function to run when loading each feature
                onEachFeature: onEachFeature
            });
            // Finally, add the layer to the map.
            leafletMap.addLayer(featureLayer);  
        }

        function init() {
          leafletMap = initMap();
          initGui();
          //get('census_blocks_housing.geojson', initTiles);
          //get('Neighborhoods_with_SNAP_Data.geojson', loadGeoJSON);

        }
        document.addEventListener('DOMContentLoaded', init, false);

    </script>
  </head>
  <body>
    <div id="map"></div>
  </body>
</html>
